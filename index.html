<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    
    <title>ç å¹´çºªäº‹</title>

    <meta name="description" content="ç å¹´çºªäº‹">
    <meta name="keywords" content="">

    

    
    <meta property="algolia:search" data-application-id="22HIZ9OHGO" data-api-key="b9e8b470b0965417b530d3806e6b8e09" data-index-name="lzqblog">
    

    

    

    

    

    

    
<link rel="stylesheet" href="/dist/build.css?v=1643276206136.css">


    
<link rel="stylesheet" href="/dist/custom.css?v=1643276206136.css">


    <script>
        window.isPost = false
        window.aomori = {
            
            
            
        }
        window.aomori_logo_typed_animated = false
        window.aomori_search_algolia = true

    </script>

<meta name="generator" content="Hexo 6.0.0"></head>

<body>

    <div class="container">
    <header class="header">
        <div class="header-type">
            
            <div class="header-type-inner">
                
                    <a class="header-type-title" href="/">ç å¹´çºªäº‹</a>
                
    
                
            </div>
        </div>
        <div class="header-menu">
            <div class="header-menu-inner">
                
            </div>
            <div class="header-menu-social">
                
            </div>
        </div>

        <div class="header-menu-mobile">
            <div class="header-menu-mobile-inner" id="mobile-menu-open">
                <i class="icon icon-menu"></i>
            </div>
        </div>
    </header>

    <div class="header-menu-mobile-menu">
        <div class="header-menu-mobile-menu-bg"></div>
        <div class="header-menu-mobile-menu-wrap">
            <div class="header-menu-mobile-menu-inner">
                <div class="header-menu-mobile-menu-close" id="mobile-menu-close">
                    <i class="icon icon-cross"></i>
                </div>
                <div class="header-menu-mobile-menu-list">
                    
                </div>
            </div>
        </div>
    </div>

</div>

    <div class="container">
        <div class="main">
            <section class="inner">
                <section class="inner-main">
                    <div class="index">
  
    
      <article
id="post-redis-code-active-expiry"
class="article article-type-post"
>



<div class="article-inner">
    

    <div class="article-body">
    <header class="article-title">
        <a href="/2022/03/31/redis-code-active-expiry/">ä»æºç çœ‹Redis â€”â€” å…³äºä¸»åŠ¨è¿‡æœŸé‚£ç‚¹äº‹</a>
    </header>
    <div class="article-entry post-inner-html">
        
        <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‰æ®µæ—¶é—´åˆ·è„‰è„‰çš„æ—¶å€™ï¼Œåˆ·åˆ°äº†è¿™æ ·ä¸€ä¸ªé¢è¯•é¢˜ï¼š<code>ä¸ºä»€ä¹ˆå¤§é‡Keyè¿‡æœŸçš„æ—¶å€™ï¼Œä¼šå½±å“æ•´ä¸ªredisæœåŠ¡çš„å»¶è¿Ÿ</code></p>
<p>å¦‚æœä½ æ˜¯é¢è¯•è€…ï¼Œä½ ä¼šæ€ä¹ˆå›ç­”ï¼Ÿ</p>
<p>å¦‚æœä½ åªçŸ¥é“redisæ˜¯ä¸€ä¸ªå•çº¿ç¨‹reactoræ¨¡å‹ï¼Œä½ å¯èƒ½ä¼šå›ç­”ï¼š<code>å› ä¸ºredisæ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œæ‰€ä»¥æ˜¯å› ä¸ºå¤„ç†åˆ é™¤keyçš„äº‹ä»¶è€—æ—¶è¿‡é•¿è€Œå¯¼è‡´å…¶ä»–äº‹ä»¶æ’é˜Ÿå¼•èµ·å»¶è¿Ÿå¢åŠ </code></p>
<p>è¿™ä¸ªå›ç­”èƒ½è®©é¢è¯•å®˜æ»¡æ„å—ï¼Ÿå¯èƒ½è¿˜ä¸å¤Ÿï¼Œä»–ä¹Ÿè®¸ä¼šç»§ç»­é—®ä½ ï¼š<code>é‚£redisä¸»åŠ¨å¤„ç†è¿‡æœŸkeyçš„æ—¶æœºæ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿå¤„ç†çš„é€»è¾‘æ˜¯ä»€ä¹ˆï¼Ÿæœ€åæƒ…å†µä¸‹ä¼šå¢åŠ å¤šå°‘å»¶è¿Ÿï¼Ÿå¦‚ä½•åˆ¤æ–­æ˜¯å› ä¸ºè¿‡æœŸkeyè€Œå¯¼è‡´çš„å»¶è¿ŸæŠ–åŠ¨ï¼Ÿå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ</code></p>
<p>åŒæ ·çš„ï¼Œå½“æ—¶çœ‹åˆ°è„‰è„‰å¸–å­ä¸Šçš„å›ç­”ï¼Œæˆ‘ä¹Ÿè§‰å¾—ä¸å¤Ÿå®Œæ•´ï¼Œæ‰€ä»¥ç´¢æ€§å¸¦ç€è¿™äº›é—®é¢˜ç¿»äº†ä¸‹redisçš„æºç ã€‚</p>
<h1 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h1><p>è¿™é‡Œæˆ‘ä»¬ä¸»è¦çœ‹ä¸»åŠ¨è¿‡æœŸéƒ¨åˆ†çš„æºç ï¼Œå¯¹äºæƒ°æ€§åˆ é™¤ã€å‘½ä»¤è°ƒç”¨åˆ°è¿‡æœŸkeyå¼•å‘çš„åˆ é™¤è¿™äº›æš‚æ—¶ä¸è®¨è®º</p>
<p>æ—¢ç„¶æ˜¯çœ‹è¿‡æœŸï¼Œæˆ‘ä»¬ç¿»åˆ°<a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/redis/redis@871fa12fec41c4d8fc008dbfb8eaf714a9cc1bfc/-/blob/src/expire.c?L113"><code>expire.cçš„activeExpireCycleå‡½æ•°</code></a>æ¥çœ‹ä¸‹å®ƒåˆ°åº•åšäº†ä»€ä¹ˆ</p>
<h2 id="ä¸»åŠ¨è¿‡æœŸå‡½æ•°æ³¨é‡Š"><a href="#ä¸»åŠ¨è¿‡æœŸå‡½æ•°æ³¨é‡Š" class="headerlink" title="ä¸»åŠ¨è¿‡æœŸå‡½æ•°æ³¨é‡Š"></a>ä¸»åŠ¨è¿‡æœŸå‡½æ•°æ³¨é‡Š</h2><p>çœ‹æºç ï¼Œå‡½æ•°çš„æ³¨é‡Šæ˜¯éå¸¸é‡è¦ï¼Œå®ƒèƒ½å¤Ÿå¸®å¿™ä¼ é€’å¼€å‘è€…çš„æƒ³æ³•ï¼Œå¸®åŠ©æˆ‘ä»¬æ›´å¿«çš„äº†è§£å…¶ç”¨æ„</p>
<pre><code>/* Try to expire a few timed out keys. The algorithm used is adaptive and
 * will use few CPU cycles if there are few expiring keys, otherwise
 * it will get more aggressive to avoid that too much memory is used by
 * keys that can be removed from the keyspace.
 *
 * Every expire cycle tests multiple databases: the next call will start
 * again from the next db. No more than CRON_DBS_PER_CALL databases are
 * tested at every iteration.
 *
 * The function can perform more or less work, depending on the &quot;type&quot;
 * argument. It can execute a &quot;fast cycle&quot; or a &quot;slow cycle&quot;. The slow
 * cycle is the main way we collect expired cycles: this happens with
 * the &quot;server.hz&quot; frequency (usually 10 hertz).
 *
 * However the slow cycle can exit for timeout, since it used too much time.
 * For this reason the function is also invoked to perform a fast cycle
 * at every event loop cycle, in the beforeSleep() function. The fast cycle
 * will try to perform less work, but will do it much more often.
 *
 * The following are the details of the two expire cycles and their stop
 * conditions:
 *
 * If type is ACTIVE_EXPIRE_CYCLE_FAST the function will try to run a
 * &quot;fast&quot; expire cycle that takes no longer than ACTIVE_EXPIRE_CYCLE_FAST_DURATION
 * microseconds, and is not repeated again before the same amount of time.
 * The cycle will also refuse to run at all if the latest slow cycle did not
 * terminate because of a time limit condition.
 *
 * If type is ACTIVE_EXPIRE_CYCLE_SLOW, that normal expire cycle is
 * executed, where the time limit is a percentage of the REDIS_HZ period
 * as specified by the ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC define. In the
 * fast cycle, the check of every database is interrupted once the number
 * of already expired keys in the database is estimated to be lower than
 * a given percentage, in order to avoid doing too much work to gain too
 * little memory.
 *
 * The configured expire &quot;effort&quot; will modify the baseline parameters in
 * order to do more work in both the fast and slow expire cycles.
 */
</code></pre>
<p>è¿™æ®µæ³¨é‡Šå¾ˆé•¿ï¼Œå¤§æ¦‚çš„å¤§æ„æ˜¯</p>
<ul>
<li>å®ƒæ‹¥æœ‰ä¸€ä¸ªè‡ªé€‚åº”çš„ç®—æ³•ï¼Œåœ¨è¿‡æœŸkeyæ¯”è¾ƒå°‘çš„æ—¶å€™å°†ä½¿ç”¨å¾ˆå°‘çš„CPUå‘¨æœŸï¼Œå¦åˆ™ä¼šè¿›è¡Œæ¿€è¿›çš„åˆ é™¤ï¼Œä»è€Œå‡å°‘å†…å­˜ä½¿ç”¨</li>
<li>æ¯æ¬¡è¿‡æœŸå¾ªç¯éƒ½ä¼šéå†å¤šä¸ªDBï¼Œä¸”ä»ä¼šä»ä¸Šæ¬¡éå†çš„ä¸‹ä¸€ä¸ªDBå¼€å§‹ï¼Œæ¯æ¬¡å¾ªç¯å˜é‡ä¸è¶…è¿‡<code>CRON_DBS_PER_CALL</code>ä¸ªDB<ul>
<li>æ³¨ï¼š<code>#define CRON_DBS_PER_CALL 16</code></li>
</ul>
</li>
<li>å‡½æ•°æ‹¥æœ‰2ä¸ªæ¨¡å¼ï¼Œå³æ…¢å¾ªç¯å’Œå¿«å¾ªç¯ï¼Œæ ¹æ®ä¼ å…¥çš„typeæ¥æ‰§è¡Œä¸åŒçš„æ¨¡å¼</li>
<li>æ…¢å¾ªç¯æ˜¯è¿‡æœŸkeyçš„åˆ é™¤ä¸»åŠ›ï¼Œä¹Ÿå°±æ˜¯è¯´æ…¢å¾ªç¯æ¨¡å¼ä¼šåˆ é™¤æ›´å¤šçš„è¿‡æœŸkeyï¼Œæ…¢å¾ªç¯æ˜¯åœ¨æ¯æ¬¡<code>server.hz</code>æ‰§è¡Œçš„ï¼Œ<code>server.hz</code>é€šå¸¸ä¸º10<ul>
<li>æ³¨ï¼š<code>server.hz</code>ä¸ºrediså‚æ•°ï¼Œå«ä¹‰ä¸ºå†…éƒ¨å®šæ—¶ä»»åŠ¡æ¯ç§’æ‰§è¡Œçš„æ¬¡æ•°ï¼Œé»˜è®¤ä¸º10ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯100msæ‰§è¡Œä¸€æ¬¡</li>
</ul>
</li>
<li>æ…¢å¾ªç¯æ‹¥æœ‰è¶…æ—¶æ§åˆ¶ï¼Œè¶…è¿‡æ‰§è¡Œæ—¶é—´ä¼šé€€å‡º</li>
<li>å› æ­¤æœ‰ä¸ªå¿«å¾ªç¯æ¨¡å¼ï¼Œåœ¨äº‹ä»¶å¾ªç¯çš„<code>beforeSleep</code>å¤„è¢«è°ƒç”¨ï¼Œç”¨äºè¡¥å……åˆ é™¤ï¼Œåˆ é™¤æ›´å°‘ä½†æ˜¯è°ƒç”¨æ›´é¢‘ç¹</li>
<li>å¦‚æœä¸ºå¿«é€Ÿå¾ªç¯æ¨¡å¼ï¼Œå°†æ‰§è¡Œä¸€ä¸ªä¸è¶…è¿‡<code>ACTIVE_EXPIRE_CYCLE_FAST_DURATION</code>æ—¶é—´çš„å¿«é€Ÿè¿‡æœŸå¾ªç¯<ul>
<li>æ³¨ï¼šå¦‚æœåŒæ—¶æœ‰æ…¢é€Ÿè¿‡æœŸå¾ªç¯æ‰§è¡Œæˆ–è€…åœ¨å’Œä¸Šä¸€æ¬¡å¾ªç¯åœ¨åŒæ—¶é—´æ®µï¼Œåˆ™ä¸ä¼šæ‰§è¡Œ</li>
<li>å¦‚æœæ‰§è¡Œä¸­é‡åˆ°DBè¿‡æœŸKeyçš„ç™¾åˆ†æ¯”è¾ƒä½ï¼Œåˆ™ä¼šæ‰“æ–­å¾ªç¯</li>
</ul>
</li>
<li>å¦‚æœä¸ºæ…¢é€Ÿå¾ªç¯æ¨¡å¼ï¼Œæ—¶é—´é™åˆ¶æ˜¯ç”±<code>ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC</code>çš„å€¼å†³å®šçš„ä¸€ä¸ª<code>REDIS_HZ</code>å‘¨æœŸçš„ç™¾åˆ†æ¯”</li>
<li>effort å‚æ•°ç”¨äºè°ƒæ•´ä¸€äº›åŸºçº¿å‚æ•°ï¼Œä»¥ä¾¿æ›´åŠ æ¿€è¿›çš„è¿›è¡Œè¿‡æœŸå›æ”¶</li>
</ul>
<h2 id="ä¸»åŠ¨è¿‡æœŸå‡½æ•°æºç "><a href="#ä¸»åŠ¨è¿‡æœŸå‡½æ•°æºç " class="headerlink" title="ä¸»åŠ¨è¿‡æœŸå‡½æ•°æºç "></a>ä¸»åŠ¨è¿‡æœŸå‡½æ•°æºç </h2><pre><code class="c">#define ACTIVE_EXPIRE_CYCLE_KEYS_PER_LOOP 20 /* Keys for each DB loop.  æ¯ä¸ªDBéå†çš„keyæ•°é‡*/
#define ACTIVE_EXPIRE_CYCLE_FAST_DURATION 1000 /* Microseconds. å¿«é€Ÿå¾ªç¯é™åˆ¶ï¼Œå•ä½å¾®å¦™ */
#define ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC 25 /* Max % of CPU to use. æœ€å¤§CPUä½¿ç”¨ç™¾åˆ†æ¯”*/
#define ACTIVE_EXPIRE_CYCLE_ACCEPTABLE_STALE 10 /* % of stale keys after which
                                                   we do extra efforts. è§¦å‘é¢å¤–å›æ”¶çš„è¿‡æœŸkeyå ç™¾åˆ†æ¯”*/

void activeExpireCycle(int type) &#123;
    /* Adjust the running parameters according to the configured expire
     * effort. The default effort is 1, and the maximum configurable effort
     * is 10. effortå‚æ•° é»˜è®¤1 æœ€å¤§10 */
    unsigned long
    effort = server.active_expire_effort-1, /* Rescale from 0 to 9. 1-10è½¬ä¸º0-9 */
    // æ ¹æ®effortè®¡ç®—ä¸Šé¢çš„ä¸€äº›å‚æ•°å®é™…å€¼
    config_keys_per_loop = ACTIVE_EXPIRE_CYCLE_KEYS_PER_LOOP +
                           ACTIVE_EXPIRE_CYCLE_KEYS_PER_LOOP/4*effort,
    config_cycle_fast_duration = ACTIVE_EXPIRE_CYCLE_FAST_DURATION +
                                 ACTIVE_EXPIRE_CYCLE_FAST_DURATION/4*effort,
    config_cycle_slow_time_perc = ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC +
                                  2*effort,
    config_cycle_acceptable_stale = ACTIVE_EXPIRE_CYCLE_ACCEPTABLE_STALE-
                                    effort;

    /* This function has some global state in order to continue the work
     * incrementally across calls. å…¨å±€çŠ¶æ€*/
    static unsigned int current_db = 0; /* Next DB to test. ä¸‹ä¸€ä¸ªDB*/
    static int timelimit_exit = 0;      /* Time limit hit in previous call? ä¸Šæ¬¡æ˜¯å¦è¶…æ—¶*/
    static long long last_fast_cycle = 0; /* When last fast cycle ran. æœ€åä¸€ä¸ªå¿«é€Ÿå‘¨æœŸ*/

    int j, iteration = 0;
    int dbs_per_call = CRON_DBS_PER_CALL;
    long long start = ustime(), timelimit, elapsed;

    /* When clients are paused the dataset should be static not just from the
     * POV of clients not being able to write, but also from the POV of
     * expires and evictions of keys not being performed. å½“clientæš‚åœæ—¶ï¼Œå›æ”¶ä¹Ÿä¸æ‰§è¡Œ*/
    if (checkClientPauseTimeoutAndReturnIfPaused()) return;
    
    // å¿«é€Ÿå›æ”¶æ¨¡å¼é¢å¤–åˆ¤æ–­
    if (type == ACTIVE_EXPIRE_CYCLE_FAST) &#123;
        /* Don&#39;t start a fast cycle if the previous cycle did not exit
         * for time limit, unless the percentage of estimated stale keys is
         * too high. Also never repeat a fast cycle for the same period
         * as the fast cycle total duration itself. */
        // å¦‚æœä¸Šæ¬¡è¶…æ—¶äº†ï¼Œè¿™æ¬¡å°±ä¸æ‰§è¡Œå¿«é€Ÿå¾ªç¯ï¼Œå½“ç„¶å¦‚æœè¿‡æœŸkeyå æ¯”è¿‡é«˜åˆ™ç»§ç»­æ‰§è¡Œ
        if (!timelimit_exit &amp;&amp;
            server.stat_expired_stale_perc &lt; config_cycle_acceptable_stale)
            return;
        // åœ¨ä¸Šæ¬¡æ‰§è¡Œçš„æ—¶é—´æ®µå†…
        if (start &lt; last_fast_cycle + (long long)config_cycle_fast_duration*2)
            return;

        last_fast_cycle = start;
    &#125;

    /* We usually should test CRON_DBS_PER_CALL per iteration, with
     * two exceptions:
     *
     * 1) Don&#39;t test more DBs than we have.
     * 2) If last time we hit the time limit, we want to scan all DBs
     * in this iteration, as there is work to do in some DB and we don&#39;t want
     * expired keys to use memory for too much time. 
     å¾ªç¯çš„DBæ•°ï¼Œé»˜è®¤ä¸ºCRON_DBS_PER_CALLè®¾ç½®å€¼ï¼Œå¦‚æœå®é™…DBæ•°å°‘äºCRON_DBS_PER_CALLæˆ–è€…ä¸Šæ¬¡æ‰§è¡Œè¶…æ—¶äº†ï¼Œåˆ™æ ¹æ®å®é™…DBæ•°éå†ï¼›
     å› ä¸ºå¦‚æœä¸Šæ¬¡è¶…æ—¶äº†åˆ™è®¤ä¸ºæœ‰å¤§é‡keyè¿‡æœŸï¼Œä¸ºäº†å‡è½»å†…å­˜å‹åŠ›ï¼Œåˆ™ä¼šæ›´åŠ æ¿€è¿›çš„å›æ”¶ */
    if (dbs_per_call &gt; server.dbnum || timelimit_exit)
        dbs_per_call = server.dbnum;

    /* We can use at max &#39;config_cycle_slow_time_perc&#39; percentage of CPU
     * time per iteration. Since this function gets called with a frequency of
     * server.hz times per second, the following is the max amount of
     * microseconds we can spend in this function. 
     æ ¹æ®å›æ”¶æ‰§è¡Œæ—¶é—´å æ¯”æ¥é™åˆ¶CPUä½¿ç”¨ç‡ */
    timelimit = config_cycle_slow_time_perc*1000000/server.hz/100;
    timelimit_exit = 0;
    if (timelimit &lt;= 0) timelimit = 1;

    if (type == ACTIVE_EXPIRE_CYCLE_FAST)
        timelimit = config_cycle_fast_duration; /* in microseconds. */

    /* Accumulate some global stats as we expire keys, to have some idea
     * about the number of keys that are already logically expired, but still
     * existing inside the database. ç»Ÿè®¡æ•°æ®ï¼Œè®°å½•æŠ½æ ·æ•°å’Œè¿‡æœŸæ•°ï¼Œç”¨äºè®¡ç®—è¿‡æœŸkeyå æ¯”*/
    long total_sampled = 0;
    long total_expired = 0;

    /* Sanity: There can&#39;t be any pending commands to propagate when
     * we&#39;re in cron æ­¤æ—¶ä¸èƒ½åœ¨è¿›è¡Œä¸»ä»æ•°æ®åŒæ­¥ç­‰æ“ä½œï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®æ ‡å¿—ä½*/
    serverAssert(server.also_propagate.numops == 0);
    server.core_propagates = 1;
    server.propagate_no_multi = 1;
    // å›æ”¶å¾ªç¯ï¼Œåªè¦æœªè¶…æ—¶ï¼Œéå†dbs_per_callæ¬¡
    for (j = 0; j &lt; dbs_per_call &amp;&amp; timelimit_exit == 0; j++) &#123;
        /* Expired and checked in a single loop. */
        unsigned long expired, sampled;

        redisDb *db = server.db+(current_db % server.dbnum);

        /* Increment the DB now so we are sure if we run out of time
         * in the current DB we&#39;ll restart from the next. This allows to
         * distribute the time evenly across DBs. */
        current_db++;

        /* Continue to expire if at the end of the cycle there are still
         * a big percentage of keys to expire, compared to the number of keys
         * we scanned. The percentage, stored in config_cycle_acceptable_stale
         * is not fixed, but depends on the Redis configured &quot;expire effort&quot;. 
         è¿‡æœŸå¹¶è®¡ç®—è¿‡æœŸkeyå æ¯”ï¼Œå¦‚æœè¶…å‡ºå‰é¢è®¡ç®—çš„æ ‡å®šå€¼ï¼Œåˆ™ä¼šä¸€ç›´æ‰§è¡Œåˆ°è¶…æ—¶æˆ–è€…è¿‡æœŸkeyå æ¯”ä¸‹é™*/
        do &#123;
            unsigned long num, slots;
            long long now, ttl_sum;
            int ttl_samples;
            iteration++;

            /* If there is nothing to expire try next DB ASAP. ç›®æ ‡dbè¿‡æœŸå­—å…¸æ²¡æœ‰æ•°æ®ï¼Œç»ˆæ­¢éå†*/
            if ((num = dictSize(db-&gt;expires)) == 0) &#123;
                db-&gt;avg_ttl = 0;
                break;
            &#125;
            slots = dictSlots(db-&gt;expires);
            now = mstime();

            /* When there are less than 1% filled slots, sampling the key
             * space is expensive, so stop here waiting for better times...
             * The dictionary will be resized asap. å­—å…¸ä½¿ç”¨ç‡è¿‡ä½çš„æƒ…å†µä¸‹ä¹Ÿç»ˆæ­¢éå†*/
            if (slots &gt; DICT_HT_INITIAL_SIZE &amp;&amp;
                (num*100/slots &lt; 1)) break;

            /* The main collection cycle. Sample random keys among keys
             * with an expire set, checking for expired ones. */
            expired = 0;
            sampled = 0;
            ttl_sum = 0;
            ttl_samples = 0;

            if (num &gt; config_keys_per_loop)
                num = config_keys_per_loop;

            /* Here we access the low level representation of the hash table
             * for speed concerns: this makes this code coupled with dict.c,
             * but it hardly changed in ten years.
             *
             * Note that certain places of the hash table may be empty,
             * so we want also a stop condition about the number of
             * buckets that we scanned. However scanning for free buckets
             * is very fast: we are in the cache line scanning a sequential
             * array of NULL pointers, so we can scan a lot more buckets
             * than keys in the same time. */
            long max_buckets = num*20;
            long checked_buckets = 0;
            // éå†æ‰€æœ‰çš„bucketï¼Œç›´åˆ°é‡‡æ ·çš„keyæ•°è¾¾åˆ°æ ‡å®šå€¼æˆ–è€…éå†å®Œæˆ
            while (sampled &lt; num &amp;&amp; checked_buckets &lt; max_buckets) &#123;
                for (int table = 0; table &lt; 2; table++) &#123;
                    if (table == 1 &amp;&amp; !dictIsRehashing(db-&gt;expires)) break;

                    unsigned long idx = db-&gt;expires_cursor;
                    idx &amp;= DICTHT_SIZE_MASK(db-&gt;expires-&gt;ht_size_exp[table]);
                    dictEntry *de = db-&gt;expires-&gt;ht_table[table][idx];
                    long long ttl;

                    /* Scan the current bucket of the current table. */
                    checked_buckets++;
                    while(de) &#123;
                        /* Get the next entry now since this entry may get
                         * deleted. */
                        dictEntry *e = de;
                        de = de-&gt;next;

                        ttl = dictGetSignedIntegerVal(e)-now;
                        // å°è¯•è¿‡æœŸå½“å‰keyï¼ŒæˆåŠŸå°±è®¡æ•°
                        if (activeExpireCycleTryExpire(db,e,now)) expired++;
                        if (ttl &gt; 0) &#123;
                            /* We want the average TTL of keys yet
                             * not expired. */
                            ttl_sum += ttl;
                            ttl_samples++;
                        &#125;
                        sampled++;
                    &#125;
                &#125;
                db-&gt;expires_cursor++;
            &#125;
            total_expired += expired;
            total_sampled += sampled;

            /* Update the average TTL stats for this database.è¾…åŠ©è®¡ç®—DBçš„å¹³å‡ttlå€¼ï¼Œæ›´æ–°å›DB */
            if (ttl_samples) &#123;
                long long avg_ttl = ttl_sum/ttl_samples;

                /* Do a simple running average with a few samples.
                 * We just use the current estimate with a weight of 2%
                 * and the previous estimate with a weight of 98%. */
                if (db-&gt;avg_ttl == 0) db-&gt;avg_ttl = avg_ttl;
                db-&gt;avg_ttl = (db-&gt;avg_ttl/50)*49 + (avg_ttl/50);
            &#125;

            /* We can&#39;t block forever here even if there are many keys to
             * expire. So after a given amount of milliseconds return to the
             * caller waiting for the other active expire cycle. è¶…æ—¶é™åˆ¶*/
            if ((iteration &amp; 0xf) == 0) &#123; /* check once every 16 iterations. */
                elapsed = ustime()-start;
                if (elapsed &gt; timelimit) &#123;
                    timelimit_exit = 1;
                    server.stat_expired_time_cap_reached_count++;
                    break;
                &#125;
            &#125;
            /* We don&#39;t repeat the cycle for the current database if there are
             * an acceptable amount of stale keys (logically expired but yet
             * not reclaimed). è¿‡æœŸkeyè¶…è¿‡å æ¯”æˆ–è€…æ²¡æœ‰éå†æ•°æ®çš„æƒ…å†µä¸‹ï¼Œé‡å¤éå†DB */
        &#125; while (sampled == 0 ||
                 (expired*100/sampled) &gt; config_cycle_acceptable_stale);
    &#125;

    serverAssert(server.core_propagates); /* This function should not be re-entrant */

    /* Propagate all DELs ä¼ æ’­åŒæ­¥åˆ é™¤çš„ç»“æœï¼Œå¹¶å›å¤æ ‡å¿—ä½*/
    propagatePendingCommands();

    server.core_propagates = 0;
    server.propagate_no_multi = 0;
    // æ‰§è¡Œæ—¶é—´ç»Ÿè®¡
    elapsed = ustime()-start;
    server.stat_expire_cycle_time_used += elapsed;
    latencyAddSampleIfNeeded(&quot;expire-cycle&quot;,elapsed/1000);

    /* Update our estimate of keys existing but yet to be expired.
     * Running average with this sample accounting for 5%. æ ¹æ®è¿‡æœŸæŠ½æ ·ç»“æœå æ¯”çš„5%æ¥æ›´æ–°ä¸€ä¸ªæœªè¿‡æœŸkeyçš„é¢„ä¼°å€¼*/
    double current_perc;
    if (total_sampled) &#123;
        current_perc = (double)total_expired/total_sampled;
    &#125; else
        current_perc = 0;
    server.stat_expired_stale_perc = (current_perc*0.05)+
                                     (server.stat_expired_stale_perc*0.95);
&#125;
</code></pre>
<h2 id="è°ƒç”¨"><a href="#è°ƒç”¨" class="headerlink" title="è°ƒç”¨"></a>è°ƒç”¨</h2><h3 id="Fastè°ƒç”¨"><a href="#Fastè°ƒç”¨" class="headerlink" title="Fastè°ƒç”¨"></a>Fastè°ƒç”¨</h3><p>è¯¥è°ƒç”¨åœ¨<code>server.c</code>çš„<a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/redis/redis@871fa12fec41c4d8fc008dbfb8eaf714a9cc1bfc/-/blob/src/server.c?L1522"><code>beforeSleep</code>å‡½æ•°</a>ä¸‹ï¼Œå¯ä»¥<a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/redis/redis@871fa12fec41c4d8fc008dbfb8eaf714a9cc1bfc/-/blob/src/server.c?L1565:9">çœ‹åˆ°</a></p>
<p>å½“å¯ç”¨ä¸»åŠ¨è¿‡æœŸï¼Œä¸”ä¸æ˜¯ä»èŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œæ¯æ¬¡è°ƒç”¨<code>beforeSleep</code>éƒ½ä¼šè°ƒç”¨ä¸€æ¬¡Fastå›æ”¶</p>
<pre><code class="c">void beforeSleep(struct aeEventLoop *eventLoop) &#123;
    /*çœç•¥Nè¡Œ*/
    /* Run a fast expire cycle (the called function will return
     * ASAP if a fast cycle is not needed). */
    if (server.active_expire_enabled &amp;&amp; server.masterhost == NULL)
        activeExpireCycle(ACTIVE_EXPIRE_CYCLE_FAST);
    /*çœç•¥Nè¡Œ*/
&#125;
</code></pre>
<p>é‚£ä¹ˆ<code>beforeSleep</code>æ˜¯å“ªé‡Œè°ƒç”¨çš„å‘¢</p>
<p>åŒæ ·çš„åœ¨<a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/redis/redis@871fa12fec41c4d8fc008dbfb8eaf714a9cc1bfc/-/blob/src/server.c?L2599"><code>server.cçš„initServerå‡½æ•°ä¸‹</code></a>å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªå¯¹<code>ae.c</code>é‡Œ<a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/redis/redis@871fa12fec41c4d8fc008dbfb8eaf714a9cc1bfc/-/blob/src/ae.c?L506"><code>aeSetBeforeSleepProc</code></a>å‡½æ•°çš„ä¸€ä¸ªè°ƒç”¨</p>
<pre><code>aeSetBeforeSleepProc(server.el,beforeSleep);
</code></pre>
<p>è¯¥å‡½æ•°å°†<code>beforeSleep</code>èµ‹å€¼ç»™äº‹ä»¶å¾ªç¯<code>aeEventLoop</code>ç»“æ„ä½“çš„<code>beforesleep</code>æŒ‡é’ˆ</p>
<pre><code>void aeSetBeforeSleepProc(aeEventLoop *eventLoop, aeBeforeSleepProc *beforesleep) &#123;
    eventLoop-&gt;beforesleep = beforesleep;
&#125;

typedef struct aeEventLoop &#123;
    int maxfd;   /* highest file descriptor currently registered */
    int setsize; /* max number of file descriptors tracked */
    long long timeEventNextId;
    aeFileEvent *events; /* Registered events */
    aeFiredEvent *fired; /* Fired events */
    aeTimeEvent *timeEventHead;
    int stop;
    void *apidata; /* This is used for polling API specific data */
    aeBeforeSleepProc *beforesleep;
    aeBeforeSleepProc *aftersleep;
    int flags;
&#125; aeEventLoop;
</code></pre>
<p>ç„¶åæˆ‘ä»¬åœ¨<a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/redis/redis@871fa12fec41c4d8fc008dbfb8eaf714a9cc1bfc/-/blob/src/ae.c?L357"><code>aeProcessEvents</code></a>äº‹ä»¶å¤„ç†å‡½æ•°ä¸­æ‰¾åˆ°è¿™æ ·çš„<a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/redis/redis@871fa12fec41c4d8fc008dbfb8eaf714a9cc1bfc/-/blob/src/ae.c?L400">è°ƒç”¨</a></p>
<pre><code class="c">int aeProcessEvents(aeEventLoop *eventLoop, int flags)
&#123;
    /*çœç•¥Nè¡Œ*/
        if (eventLoop-&gt;beforesleep != NULL &amp;&amp; flags &amp; AE_CALL_BEFORE_SLEEP)
            eventLoop-&gt;beforesleep(eventLoop);
    /*çœç•¥Nè¡Œ*/
    
    /* Check time events */
    if (flags &amp; AE_TIME_EVENTS)    // æ‰§è¡Œæ—¶é—´äº‹ä»¶ ä¹‹åä¼šæœ‰ç›¸å…³
        processed += processTimeEvents(eventLoop);

    return processed; /* return the number of processed file/time events */
&#125;
</code></pre>
<p><code>aeProcessEvents</code>æ˜¯å“ªé‡Œè°ƒç”¨å‘¢ï¼Ÿç­”æ¡ˆæ˜¯åŸºæœ¬æ‰€æœ‰çš„æ“ä½œéƒ½ä¼šè°ƒç”¨åˆ°å“¦ï¼Œæ€»æ‰€å‘¨çŸ¥<code>redis</code>æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼ŒåŸºæœ¬æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯è½¬åŒ–ä¸ºæ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´å®ç°æ¥æ‰§è¡Œçš„ï¼Œè€Œ<code>aeProcessEvents</code>å°±æ˜¯æ‰€æœ‰äº‹ä»¶çš„å¤„ç†å…¥å£</p>
<p>ä¸»è¦çš„è°ƒç”¨å¤„æœ‰è¿™2ä¸ªåœ°æ–¹</p>
<p><strong>ä¸»äº‹ä»¶å¾ªç¯</strong></p>
<p><a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/redis/redis@871fa12fec41c4d8fc008dbfb8eaf714a9cc1bfc/-/blob/src/ae.c?L493:6"><code>ae.cçš„aeMain</code></a>å‡½æ•°</p>
<pre><code class="c">void aeMain(aeEventLoop *eventLoop) &#123;
    eventLoop-&gt;stop = 0;
    while (!eventLoop-&gt;stop) &#123;
        aeProcessEvents(eventLoop, AE_ALL_EVENTS|
                                   AE_CALL_BEFORE_SLEEP|
                                   AE_CALL_AFTER_SLEEP);
    &#125;
&#125;
</code></pre>
<p><strong>é˜»å¡å¤„ç†</strong></p>
<p><a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/redis/redis@871fa12fec41c4d8fc008dbfb8eaf714a9cc1bfc/-/blob/src/networking.c?L3891"><code>networking.cçš„processEventsWhileBlockedå‡½æ•°</code></a> ï¼Œåœ¨<code>aof</code>ã€<code>rdb</code>ã€è„šæœ¬ä¸­æ–­ã€moduleç­‰åœ°æ–¹éƒ½ä¼šè°ƒç”¨åˆ°ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è¿›ä¸€æ­¥æ¢ç©¶</p>
<pre><code class="c">/* This function is called by Redis in order to process a few events from
 * time to time while blocked into some not interruptible operation.
 * This allows to reply to clients with the -LOADING error while loading the
 * data set at startup or after a full resynchronization with the master
 * and so forth.
 *
 * It calls the event loop in order to process a few events. Specifically we
 * try to call the event loop 4 times as long as we receive acknowledge that
 * some event was processed, in order to go forward with the accept, read,
 * write, close sequence needed to serve a client.
 *
 * The function returns the total number of events processed. */
void processEventsWhileBlocked(void) &#123;
    int iterations = 4; /* See the function top-comment. */

    /* Update our cached time since it is used to create and update the last
     * interaction time with clients and for other important things. */
    updateCachedTime(0);

    /* Note: when we are processing events while blocked (for instance during
     * busy Lua scripts), we set a global flag. When such flag is set, we
     * avoid handling the read part of clients using threaded I/O.
     * See https://github.com/redis/redis/issues/6988 for more info.
     * Note that there could be cases of nested calls to this function,
     * specifically on a busy script during async_loading rdb, and scripts
     * that came from AOF. */
    ProcessingEventsWhileBlocked++;
    while (iterations--) &#123;
        long long startval = server.events_processed_while_blocked;
        long long ae_events = aeProcessEvents(server.el,
            AE_FILE_EVENTS|AE_DONT_WAIT|
            AE_CALL_BEFORE_SLEEP|AE_CALL_AFTER_SLEEP);
        /* Note that server.events_processed_while_blocked will also get
         * incremented by callbacks called by the event loop handlers. */
        server.events_processed_while_blocked += ae_events;
        long long events = server.events_processed_while_blocked - startval;
        if (!events) break;
    &#125;

    whileBlockedCron();

    ProcessingEventsWhileBlocked--;
    serverAssert(ProcessingEventsWhileBlocked &gt;= 0);
&#125;
</code></pre>
<h3 id="Slowè°ƒç”¨"><a href="#Slowè°ƒç”¨" class="headerlink" title="Slowè°ƒç”¨"></a>Slowè°ƒç”¨</h3><p>æˆ‘ä»¬å¯ä»¥åœ¨<a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/redis/redis@871fa12fec41c4d8fc008dbfb8eaf714a9cc1bfc/-/blob/src/server.c?L992"><code>server.cçš„databasesCronå‡½æ•°</code></a>æ‰¾åˆ°å¯¹åº”çš„è°ƒç”¨</p>
<p>å½“å‰èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¼šä»¥Slowæ¨¡å¼è°ƒç”¨</p>
<pre><code class="c">void databasesCron(void) &#123;
    /* Expire keys by random sampling. Not required for slaves
     * as master will synthesize DELs for us. */
    if (server.active_expire_enabled) &#123;
        if (iAmMaster()) &#123;
            activeExpireCycle(ACTIVE_EXPIRE_CYCLE_SLOW);
        &#125; else &#123;
            expireSlaveKeys();
        &#125;
    &#125;
    /*ä»¥ä¸‹çœç•¥*/
&#125;
</code></pre>
<p>åŒæ ·çš„,æˆ‘ä»¬æ‰¾åˆ°è°ƒç”¨æ–¹<a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/redis/redis@871fa12fec41c4d8fc008dbfb8eaf714a9cc1bfc/-/blob/src/server.c?L1179"><code>serverCron</code></a></p>
<p>è¿™é‡Œæ³¨é‡Šå‘Šè¯‰æˆ‘ä»¬ï¼Œè¿™é‡Œçš„cronå‡½æ•°æ¯ç§’æ‰§è¡Œ<code>server.hz</code>ï¼Œå³é»˜è®¤æ¯ç§’æ‰§è¡Œ10æ¬¡ï¼Œ100msæ‰§è¡Œä¸€æ¬¡</p>
<ul>
<li>æ³¨ï¼š<code>server.hz</code>æ˜¯ä¸€ä¸ªé…ç½®ï¼Œé»˜è®¤ä¸º10</li>
</ul>
<pre><code class="c">/* This is our timer interrupt, called server.hz times per second.
 * Here is where we do a number of things that need to be done asynchronously.
 * For instance:
 *
 * - Active expired keys collection (it is also performed in a lazy way on
 *   lookup).
 * - Software watchdog.
 * - Update some statistic.
 * - Incremental rehashing of the DBs hash tables.
 * - Triggering BGSAVE / AOF rewrite, and handling of terminated children.
 * - Clients timeout of different kinds.
 * - Replication reconnection.
 * - Many more...
 *
 * Everything directly called here will be called server.hz times per second,
 * so in order to throttle execution of things we want to do less frequently
 * a macro is used: run_with_period(milliseconds) &#123; .... &#125;
 */
int serverCron(struct aeEventLoop *eventLoop, long long id, void *clientData) &#123;
    /*çœç•¥Nè¡Œ*/
    /* Handle background operations on Redis databases. */
    databasesCron();
    /*çœç•¥Nè¡Œ*/
    return 1000/server.hz;    // æ§åˆ¶æ‰§è¡Œé¢‘ç‡ï¼Œå³æ¯ç§’server.hzæ¬¡ï¼Œå…·ä½“ä½¿ç”¨è§ä¸‹æ–¹
&#125;
</code></pre>
<p>ç„¶ååœ¨<a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/redis/redis@871fa12fec41c4d8fc008dbfb8eaf714a9cc1bfc/-/blob/src/server.c?L2386"><code>initServer</code></a>å‡½æ•°ä¸‹ï¼Œå¯ä»¥æ‰¾åˆ°æ—¶é—´äº‹ä»¶çš„æ³¨å†Œç‚¹</p>
<pre><code class="c">    /* Create the timer callback, this is our way to process many background
     * operations incrementally, like clients timeout, eviction of unaccessed
     * expired keys and so forth. */
    if (aeCreateTimeEvent(server.el, 1, serverCron, NULL, NULL) == AE_ERR) &#123;
        serverPanic(&quot;Can&#39;t create event loop timers.&quot;);
        exit(1);
    &#125;
</code></pre>
<p>é‚£ä¹ˆ<code>redis</code>æ˜¯æ€ä¹ˆæ§åˆ¶æ—¶é—´äº‹ä»¶çš„æ‰§è¡Œé—´éš”çš„å‘¢</p>
<p>æˆ‘ä»¬å›åˆ°<code>ae.c</code>æ¥çœ‹<a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/redis/redis@871fa12fec41c4d8fc008dbfb8eaf714a9cc1bfc/-/blob/src/ae.c?L276"><code>processTimeEventså‡½æ•°</code></a></p>
<pre><code class="c">static int processTimeEvents(aeEventLoop *eventLoop) &#123;
    int processed = 0;
    aeTimeEvent *te;
    long long maxId;

    te = eventLoop-&gt;timeEventHead;
    maxId = eventLoop-&gt;timeEventNextId-1;
    monotime now = getMonotonicUs();
    while(te) &#123;
        long long id;

        /* Remove events scheduled for deletion. */
        if (te-&gt;id == AE_DELETED_EVENT_ID) &#123;
            aeTimeEvent *next = te-&gt;next;
            /* If a reference exists for this timer event,
             * don&#39;t free it. This is currently incremented
             * for recursive timerProc calls */
            if (te-&gt;refcount) &#123;
                te = next;
                continue;
            &#125;
            if (te-&gt;prev)
                te-&gt;prev-&gt;next = te-&gt;next;
            else
                eventLoop-&gt;timeEventHead = te-&gt;next;
            if (te-&gt;next)
                te-&gt;next-&gt;prev = te-&gt;prev;
            if (te-&gt;finalizerProc) &#123;
                te-&gt;finalizerProc(eventLoop, te-&gt;clientData);
                now = getMonotonicUs();
            &#125;
            zfree(te);
            te = next;
            continue;
        &#125;

        /* Make sure we don&#39;t process time events created by time events in
         * this iteration. Note that this check is currently useless: we always
         * add new timers on the head, however if we change the implementation
         * detail, this check may be useful again: we keep it here for future
         * defense. */
        if (te-&gt;id &gt; maxId) &#123;
            te = te-&gt;next;
            continue;
        &#125;

        if (te-&gt;when &lt;= now) &#123;    // å¦‚æœé¢„æœŸæ‰§è¡Œæ—¶é—´&lt;=å½“å‰æ—¶é—´
            int retval;

            id = te-&gt;id;
            te-&gt;refcount++;
            retval = te-&gt;timeProc(eventLoop, id, te-&gt;clientData);    // äº‹ä»¶å›è°ƒè¿”å›å€¼
            te-&gt;refcount--;
            processed++;
            now = getMonotonicUs();
            if (retval != AE_NOMORE) &#123;
                te-&gt;when = now + retval * 1000;    // æ ¹æ®äº‹ä»¶å›è°ƒè¿”å›çš„å€¼æ¥è®¡ç®—ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´
            &#125; else &#123;
                te-&gt;id = AE_DELETED_EVENT_ID;
            &#125;
        &#125;
        te = te-&gt;next;
    &#125;
    return processed;
&#125;
</code></pre>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ•´ä¸ª<code>redis</code>ä¸»åŠ¨è¿‡æœŸæºç çš„æµç¨‹è§£è¯»å°±åˆ°è¿™é‡Œï¼Œç°åœ¨æˆ‘ä»¬å›å¤´æ¥è§£ç­”å‰é¢æåˆ°çš„é‚£å‡ ä¸ªé—®é¢˜</p>
<p>Qï¼š<code>redis</code>ä¸»åŠ¨å¤„ç†è¿‡æœŸkeyçš„æ—¶æœºæ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ</p>
<p>Aï¼š1. æ¯æ¬¡æ‰§è¡Œäº‹ä»¶çš„æ—¶å€™éƒ½ä¼šå°è¯•è°ƒç”¨å¿«é€Ÿå¾ªç¯æ¨¡å¼ï¼›2. å†…éƒ¨æ—¶é—´äº‹ä»¶æ¯ç§’æ‰§è¡Œ<code>server.hz</code>æ¬¡æ…¢é€Ÿå¾ªç¯æ¨¡å¼ï¼Œå³é»˜è®¤æ¯100msæ‰§è¡Œä¸€æ¬¡</p>
<p>Qï¼š ä¸»åŠ¨å¤„ç†çš„é€»è¾‘æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>Aï¼šé€šå¸¸æƒ…å†µä¸‹å¾ªç¯éå†ä¸è¶…è¿‡16ä¸ªDBï¼Œæ¯ä¸ªDBå–20ä¸ªè¿‡æœŸkeyè¿›è¡Œå¤„ç†ï¼Œå¹¶æ ¹æ®éå†å’Œè¿‡æœŸçš„æƒ…å†µï¼Œè®¡ç®—è¿‡æœŸkeyå æ¯”ï¼Œå¦‚æœå æ¯”è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™æŒç»­å›æ”¶è‡³è¶…æ—¶æˆ–è€…å æ¯”ä½äºé˜ˆå€¼ã€‚</p>
<p>Q: æœ€åæƒ…å†µä¸‹ä¼šå¢åŠ å¤šå°‘å»¶è¿Ÿï¼Ÿ</p>
<p>Aï¼šåœ¨é»˜è®¤çš„å‚æ•°ä¸‹ï¼Œç”±äºå¿«é€Ÿå¾ªç¯çš„å­˜åœ¨ï¼Œæ¯æ¬¡äº‹ä»¶æœ€å¤šä¼šå¢åŠ 1msçš„å»¶è¿Ÿï¼›ç”±äºæ…¢å¾ªç¯çš„å­˜åœ¨ï¼Œæ¯100msæœ€å¤šä¼šå¢åŠ 25msçš„å»¶è¿Ÿ</p>
<p>Qï¼šå¦‚ä½•åˆ¤æ–­æ˜¯å› ä¸ºè¿‡æœŸkeyè€Œå¯¼è‡´çš„å»¶è¿ŸæŠ–åŠ¨ï¼Ÿ</p>
<p>Aï¼šä¸»åŠ¨è¿‡æœŸæ“ä½œæ‰§è¡Œæ—¶é—´ä¼šç»Ÿè®¡è‡³<code>stat_expire_cycle_time_used</code>å¯ä»¥ç”±æ­¤è¿›è¡Œåˆ¤å®š</p>
<p>Qï¼šå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ</p>
<p>Aï¼šé¿å…å¤§é‡keyåŒæ—¶è¿‡æœŸï¼Œå¦‚å°†keyçš„è¿‡æœŸæ—¶é—´åœ¨ä¸€å®šèŒƒå›´å†…è¿›è¡ŒéšæœºåŒ–å¤„ç†ç­‰ã€‚</p>

        
    </div>
    </div>

    <div class="article-badge">
        
        
    </div>

</div>

<footer class="article-footer">
    <div class="article-more-info">
    <div class="article-date">
  <time datetime="2022-03-31T06:43:15.000Z" itemprop="datePublished">2022-03-31</time>
</div>
    
    
    </div>
</footer>

</article>

    
  
    
      <article
id="post-manjaro-for-zephyrus-g14"
class="article article-type-post"
>



<div class="article-inner">
    

    <div class="article-body">
    <header class="article-title">
        <a href="/2022/03/03/manjaro-for-zephyrus-g14/">ROG Zephyrus G14 Manjaro-KDE åˆæ­¥å®‰è£…ä½“éªŒ</a>
    </header>
    <div class="article-entry post-inner-html">
        
        <h1 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h1><p>ä¹‹å‰æˆ‘ä¸»åŠ›çš„å¼€å‘ç¯å¢ƒè¿˜æ˜¯åœ¨Windowsä¸‹ï¼Œéœ€è¦Linuxçš„éƒ¨åˆ†ä¸€èˆ¬ä½¿ç”¨WSLæ¥å®Œæˆï¼Œæœ€è¿‘é—²æ¥æ— äº‹ï¼Œæ‰“ç®—ç»™ç¬”è®°æœ¬è£…ä¸ªLinuxç©ç©ã€‚å…³äºå‘è¡Œç‰ˆçš„é€‰æ‹©ï¼Œå‡ ç»è€ƒè™‘è¿˜æ˜¯é€‰æ‹©äº†ç›¸å¯¹æ¥è¯´æ¯”è¾ƒç«çš„Manjaroï¼Œä¸€æ¥æ—¢ç„¶æ˜¯æŠ˜è…¾ï¼Œè¿˜æ˜¯æ‰“ç®—é€‰æ‹©ä¸€ä¸ªæ»šåŠ¨å‘ç°ç‰ˆçš„ç³»ç»Ÿï¼Œæœ€åå–èˆä¹‹ä¸‹å°±é€‰äº†Manjaroï¼Œè‡³äºä¸ºä»€ä¹ˆæ˜¯KDEï¼Œå¤§æ¦‚æ˜¯å› ä¸ºä¹‹å‰ä¹Ÿç”¨è¿‡GNOMEï¼Œæ‰“ç®—æ¢ä¸ªå£å‘³ã€‚ğŸ˜Š</p>
<h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><p>ç”±äºæœ‰å›¾å½¢åŒ–çš„ç•Œé¢ï¼Œè¿™å—æ˜¯æ¯”è¾ƒç®€å•çš„äº†ï¼Œä¸‹è½½å®Œé•œåƒåä½¿ç”¨<code>rufus</code>åšä¸€ä¸ªå¯åŠ¨ç›˜ï¼ŒBIOSä¸Šé€‰å¥½ä¼˜å…ˆçº§ï¼Œå¾ˆå®¹æ˜“å°±è¿›å…¥å¯åŠ¨èœå•äº†ã€‚<br>ä¸€å¼€å§‹é»˜è®¤æœ‰2ä¸ªå®‰è£…é€‰æ‹©ï¼Œé—­æºé©±åŠ¨çš„ç‰ˆæœ¬å’Œå¼€æºé©±åŠ¨çš„ç‰ˆæœ¬ï¼Œç”±äºæˆ‘è¿™ä¸ªç¬”è®°æœ¬æ˜¯ç»¿å‚æ˜¾å¡çš„ï¼Œå› ä¸º<code>fxxk Nvidia</code>çš„åŸå› ï¼Œé€‰äº†é—­æºé©±åŠ¨çš„ç‰ˆæœ¬ï¼Œè¿™æ ·ç¨³å®šæ€§ä¸Šç›¸å¯¹æ¥è¯´ä¼šæ›´å¥½ã€‚</p>
<p>å‰©ä¸‹çš„å°±æ˜¯æ ¹æ®GUIçš„æç¤ºé€‰æ‹©å¥½åˆ†åŒºï¼Œå®‰è£…å®Œäº‹ã€‚</p>
<h1 id="æŠ˜è…¾"><a href="#æŠ˜è…¾" class="headerlink" title="æŠ˜è…¾"></a>æŠ˜è…¾</h1><h2 id="æ¢æº"><a href="#æ¢æº" class="headerlink" title="æ¢æº"></a>æ¢æº</h2><p>å…ˆæŠŠå®˜æ–¹æºæ›¿æ¢æˆå›½å†…é•œåƒ</p>
<pre><code>sudo pacman-mirrors -i -c China -m rank
</code></pre>
<p>ç„¶ååœ¨<code>/etc/pacman.conf</code>æ·»åŠ ä¸€ä¸‹ä¸­æ–‡è½¯ä»¶åŒ…</p>
<pre><code>[archlinuxcn]
SigLevel = TrustAll
Server = https://mirrors.tuna.tsinghua.edu.cn/archlinuxcn/$arch

[arch4edu]
SigLevel = TrustAll
Server = https://mirrors.tuna.tsinghua.edu.cn/arch4edu/$arch
</code></pre>
<p>æ›´æ–°ç³»ç»Ÿ</p>
<pre><code>sudo pacman -Syyu
</code></pre>
<h2 id="å®‰è£…yay"><a href="#å®‰è£…yay" class="headerlink" title="å®‰è£…yay"></a>å®‰è£…yay</h2><pre><code>sudo pacman -S yay
</code></pre>
<p>yayæ˜¯ä¸€ä¸ªgoå†™çš„auråŠ©æ‰‹ï¼Œç›¸æ¯”æ¥è¯´æ¯”å®˜æ–¹æœ‰æ›´å¤šçš„è½¯ä»¶åŒ…ï¼Œå¯ä»¥å®‰è£…ä¸€äº›å®˜æ–¹æºæ‰¾ä¸åˆ°çš„è½¯ä»¶åŒ…</p>
<h2 id="å¸¸ç”¨è½¯ä»¶å®‰è£…"><a href="#å¸¸ç”¨è½¯ä»¶å®‰è£…" class="headerlink" title="å¸¸ç”¨è½¯ä»¶å®‰è£…"></a>å¸¸ç”¨è½¯ä»¶å®‰è£…</h2><h3 id="è¾“å…¥æ³•"><a href="#è¾“å…¥æ³•" class="headerlink" title="è¾“å…¥æ³•"></a>è¾“å…¥æ³•</h3><p>è¿™é‡Œå®‰è£…çš„æ˜¯rimeï¼Œä¸€èˆ¬è¿˜ä¼šè°ƒæ•´è¾“å…¥æ–¹æ¡ˆã€ä¸»é¢˜ç­‰ï¼Œè¿™äº›è¯¦ç»†çš„é…ç½®ç½‘ä¸Šå·²ç»æœ‰æ¯”è¾ƒå¤šçš„è¯´æ˜äº†ï¼Œå°±ä¸å…·ä½“åˆ—äº†</p>
<pre><code>yay -S fcitx5-im fcitx5-configtool fcitx5-rime
</code></pre>
<p>ä¿®æ”¹.xprofile</p>
<pre><code>export GTK_IM_MODULE=fcitx
export QT_IM_MODULE=fcitx
export SDL_IM_MODULE=fcitx
export XMODIFIERS=&quot;@im=fcitx&quot;
export LANG=&quot;zh_CN.UTF-8&quot;
export LC_CTYPE=&quot;zh_CN.UTF-8&quot;
</code></pre>
<h3 id="Chrome"><a href="#Chrome" class="headerlink" title="Chrome"></a>Chrome</h3><p>è‡ªå¸¦çš„Firefoxä¸ä¹ æƒ¯ï¼Œè¿˜æ˜¯ä¹ æƒ¯Chrome</p>
<pre><code>yay -S google-chrome
</code></pre>
<h3 id="è…¾è®¯è½¯ä»¶"><a href="#è…¾è®¯è½¯ä»¶" class="headerlink" title="è…¾è®¯è½¯ä»¶"></a>è…¾è®¯è½¯ä»¶</h3><p>å…·ä½“å¯çœ‹è¿™2ä¸ªrepo<br>å¦‚æœç¬”è®°æœ¬è°ƒäº†ç³»ç»Ÿç¼©æ”¾æ¯”ä¾‹ï¼Œç”±äºwineè½¯ä»¶æ˜¯ä¸ä¼šè·Ÿéšè¿™ä¸ªé…ç½®çš„ï¼Œéœ€è¦å•ç‹¬å»é…ç½®dpi</p>
<pre><code>https://github.com/vufa/deepin-wine-tim-arch
https://github.com/vufa/deepin-wine-wechat-arch
</code></pre>
<h3 id="ç§‘å­¦ä¸Šç½‘"><a href="#ç§‘å­¦ä¸Šç½‘" class="headerlink" title="ç§‘å­¦ä¸Šç½‘"></a>ç§‘å­¦ä¸Šç½‘</h3><p>è¿™é‡Œæ¨èQv2rayï¼Œè™½ç„¶å·²ç»ä¸å†ç»´æŠ¤äº†ï¼Œä½†æ˜¯ç›®å‰æ˜¯å¤Ÿç”¨çš„</p>
<pre><code>https://github.com/Qv2ray/Qv2ray
</code></pre>
<p>å¯ä»¥ç›´æ¥ç”¨yayä¸‹è½½ï¼Œå¦‚æœä»githubä¸‹å®‰è£…åŒ…çš„è¯ï¼Œå¯èƒ½éœ€è¦å®‰è£…ä¾èµ–<code> libxcrypt-compat</code></p>
<h2 id="ç»ˆç«¯é…ç½®"><a href="#ç»ˆç«¯é…ç½®" class="headerlink" title="ç»ˆç«¯é…ç½®"></a>ç»ˆç«¯é…ç½®</h2><p>Manjaroé»˜è®¤å°±å¯ç”¨äº†zshï¼Œè¿™è¾¹ä½¿ç”¨oh-my-zshæ¥å¢å¼ºï¼Œè‡³äºæ’ä»¶ä¸»é¢˜å•¥çš„å°±æŒ‰ä¸ªäººå–œæ¬¢ä¿®æ”¹äº†</p>
<pre><code>sh -c &quot;$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)&quot;
cp ~/.oh-my-zsh/templates/zshrc.zsh-template ~/.zshrc
</code></pre>
<p>å‘½ä»¤è¡Œçš„å·¥å…·<br>è¿™è¾¹åœ¨ç½‘ä¸Šçœ‹åˆ°ä¸€ä¸ªåˆé›†ï¼ŒæŒºä¸é”™çš„ <a target="_blank" rel="noopener" href="https://www.kawabangga.com/posts/3084">åˆé›†</a></p>
<h2 id="å¼€å‘å·¥å…·"><a href="#å¼€å‘å·¥å…·" class="headerlink" title="å¼€å‘å·¥å…·"></a>å¼€å‘å·¥å…·</h2><p>è¿™é‡Œè£…äº†vscode postman</p>
<pre><code>yay -S visual-studio-code-bin postman
</code></pre>
<p>ç„¶åå®‰è£…äº†JetBrainså®¶çš„IDE</p>
<h2 id="åç¡•ç¬”è®°æœ¬ç›¸å…³"><a href="#åç¡•ç¬”è®°æœ¬ç›¸å…³" class="headerlink" title="åç¡•ç¬”è®°æœ¬ç›¸å…³"></a>åç¡•ç¬”è®°æœ¬ç›¸å…³</h2><p>gitlabä¸Šæœ‰ä¸€ä¸ªç©å®¶è‡ªå‘å¼€å‘çš„åç¡•ç¬”è®°æœ¬çš„linuxå·¥å…·<a target="_blank" rel="noopener" href="https://gitlab.com/asus-linux">ä»“åº“</a><br><code>asusctl</code>å¯ä»¥ç”¨äºç”µæ± å……ç”µæ§åˆ¶ã€LEDæ§åˆ¶ç­‰ç­‰<br><code>supergfxctl</code>ç”¨äºæ˜¾å¡åˆ‡æ¢ </p>
<h2 id="å­—ä½“-x2F-ç¾åŒ–"><a href="#å­—ä½“-x2F-ç¾åŒ–" class="headerlink" title="å­—ä½“&#x2F;ç¾åŒ–"></a>å­—ä½“&#x2F;ç¾åŒ–</h2><p>è¿™éƒ¨åˆ†éƒ½æ˜¯çœ‹ä¸ªäººå–œå¥½äº†ï¼Œä¸è¿‡KDEçš„å­—ä½“æ¸²æŸ“è¿˜æ˜¯æŒºç³Ÿç³•çš„ï¼Œè¿™è¾¹æ¢äº†<code>æ–‡æ³‰é©¿</code>çš„å­—ä½“</p>
<pre><code>yay -S wqy-zenhei wqy-bitmapfont
</code></pre>
<h1 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h1><p>å…¶å®å¯ä»¥æŠ˜è…¾çš„ä¸œè¥¿æœ‰å¾ˆå¤šï¼Œæœ¬æ–‡ä¹Ÿä¼šæŒç»­æ›´æ–°ä½¿ç”¨æƒ…å†µ</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/114296129">Manjaro-KDEå®‰è£…é…ç½®å…¨æ”»ç•¥</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/2d096cd9ad61">manjaro åˆ‡æ¢å›½å†…æºåŠè½¯ä»¶å®‰è£…</a></p>

        
    </div>
    </div>

    <div class="article-badge">
        
        
    </div>

</div>

<footer class="article-footer">
    <div class="article-more-info">
    <div class="article-date">
  <time datetime="2022-03-03T10:17:08.000Z" itemprop="datePublished">2022-03-03</time>
</div>
    
    
    </div>
</footer>

</article>

    
  
    
      <article
id="post-fix-concurrent-monkey-windows"
class="article article-type-post"
>



<div class="article-inner">
    

    <div class="article-body">
    <header class="article-title">
        <a href="/2022/02/22/fix-concurrent-monkey-windows/">ä¿®æ­£monkeyè¡¥ä¸åœ¨windowsä¸‹å¤±è´¥çš„é—®é¢˜</a>
    </header>
    <div class="article-entry post-inner-html">
        
        <h1 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h1><p>å…¬å¸å†…æ­£åœ¨åšçš„ä¸€ä¸ªé¡¹ç›®æœ€è¿‘æ­£åœ¨å†™æ¥å£é›†æˆæµ‹è¯•çš„è„šæœ¬ï¼Œä½†æ˜¯ç”±äºé¡¹ç›®å†…éƒ¨åˆ†ä»£ç ä½¿ç”¨äº†å…¨å±€å•ä¾‹ï¼Œè¿™éƒ¨åˆ†å¾ˆéš¾è¿›è¡Œmockæµ‹è¯•ï¼Œè™½ç„¶é€šè¿‡gomonkeyå¯ä»¥è¿›è¡Œä¸€å®šç¨‹åº¦çš„patchï¼Œä½†æ˜¯ç”±äºgomonkeyå½“å‰æ˜¯éåç¨‹å®‰å…¨çš„ï¼Œä¹Ÿå°±æ˜¯æ²¡åŠæ³•åšå¹¶è¡Œçš„æµ‹è¯•ï¼Œç„¶è€Œæˆ‘ä»¬çš„é¡¹ç›®ç”¨ä¾‹å¾ˆå¤šï¼Œå¦‚æœè¿›è¡Œä¸²è¡Œæµ‹è¯•ï¼Œæ•´ä¸ªCIæµç¨‹èµ°ä¸‹æ¥è¦æ¥è¿‘10åˆ†é’Ÿï¼Œè¿™ä¼šéå¸¸å½±å“å¼€å‘çš„æ•ˆç‡ï¼Œæ•…æˆ‘å¼€å§‹å¯»æ±‚è§£å†³æ–¹æ¡ˆã€‚</p>
<h1 id="è½¬æœº"><a href="#è½¬æœº" class="headerlink" title="è½¬æœº"></a>è½¬æœº</h1><p>æœ€ç»ˆåœ¨ç½‘ä¸Šå‘ç°äº†æœ‰äººåšäº†ä¸€ä¸ªæ”¯æŒå¤šåç¨‹çš„monkeyè¡¥ä¸<a target="_blank" rel="noopener" href="https://github.com/go-kiss/monkey">go-kiss&#x2F;monkey</a>ï¼Œçœ‹äº†ä½œè€…çš„<a target="_blank" rel="noopener" href="https://taoshu.in/go/monkey.html">å®ç°æ–‡ç« </a>åï¼Œå…¶åŸºæœ¬åŸç†å°±æ˜¯é€šè¿‡å†™å…¥ä¸€æ®µæ±‡ç¼–å®ç°çš„switchä»£ç æ®µï¼Œé€šè¿‡å½“å‰åç¨‹IDçš„æ¯”è¾ƒï¼Œè¿›è¡Œåˆ†æ”¯è·³è½¬åˆ°ä¸åŒçš„patchä¸Šï¼Œè™½ç„¶å½“å‰çš„ç‰ˆæœ¬æ¯”è¾ƒç²—ç³™ï¼Œå®‰å…¨æ€§æ®è¯´ä¹Ÿæ²¡æœ‰å®Œå–„å¤„ç†ï¼Œä½†æ˜¯ä½œä¸ºæµ‹è¯•æˆ‘è§‰å¾—æ˜¯å¤Ÿç”¨äº†ï¼Œæ‰€ä»¥æ‰“ç®—åœ¨é¡¹ç›®é‡Œå…ˆè¯•è¯•ã€‚</p>
<h1 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h1><p>æµ‹è¯•è¿™ä¸ªmonkeyåº“çš„æ—¶å€™å‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨AMD64 + Linux çš„ç¯å¢ƒä¸‹æ˜¯èƒ½å¤Ÿæ­£å¸¸è·‘é€šç‹¬ç«‹patchçš„é€»è¾‘ï¼Œä½†æ˜¯AMD64 + Windowsä¸‹å´å¤±æ•ˆäº†ï¼Œç„¶è€Œæˆ‘å¸ä¸å°‘å°ä¼™ä¼´çš„å¼€å‘æœºè¿˜æ˜¯ä½¿ç”¨Windowså¹³å°ï¼Œå¦‚æœåœ¨Windowsä¸‹æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œå°±éœ€è¦ç”¨wslç­‰æ–¹å¼æ¥è·‘è‡ªæµ‹ï¼Œè¿™æ ·ä¼šå½±å“åˆ°åŸå…ˆçš„å¼€å‘æµç¨‹ã€‚æ—¢ç„¶ä½œè€…æŠŠåŸºæœ¬åŸç†éƒ½æä¾›äº†ï¼Œæ•…æˆ‘æ‰“ç®—å°è¯•è§£å†³è¿™ä¸ªBugã€‚</p>
<h1 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h1><h2 id="æ’æŸ¥Hookæµç¨‹"><a href="#æ’æŸ¥Hookæµç¨‹" class="headerlink" title="æ’æŸ¥Hookæµç¨‹"></a>æ’æŸ¥Hookæµç¨‹</h2><p>å†™äº†ä¸€æ®µæµ‹è¯•ä»£ç ç”¨äºæ’æŸ¥ï¼Œæ‰§è¡Œååœåœ¨inputå¤„ï¼Œæ‹¿x86debugé™„åŠ è¿›å»ï¼Œæ‰¾åˆ°åç¨‹åˆ¤æ–­çš„æ±‡ç¼–æ®µ</p>
<pre><code>import (
    &quot;fmt&quot;
    &quot;github.com/go-kiss/monkey&quot;
)

//go:noinline
func Add(a, b int) int &#123;
    return a + b
&#125;

func Add1(a, b int) int &#123;
    return 10
&#125;


func main() &#123;
    monkey.Patch(Add, Add1)
    var input string
    fmt.Scanln(&amp;input)
    fmt.Printf(&quot;g1 add = %d\n&quot;, Add(99, 99))
&#125;
</code></pre>
<p>å‘ç°å…¶åˆ¤æ–­åç¨‹IDçš„é€»è¾‘æ²¡æœ‰é€šè¿‡ï¼Œç„¶è€Œæµ‹è¯•ä»£ç åªæœ‰ä¸€ä¸ªåç¨‹ï¼Œæ˜æ˜¾å’Œæˆ‘ä»¬çš„é¢„æœŸç›¸æ‚–ï¼ŒæŒ‰ç†æƒ³é€»è¾‘ï¼Œcmpåº”è¯¥æˆåŠŸï¼Œä¸èµ°jneè·³è½¬ï¼Œå®é™…ä¸Šå´åˆ¤æ–­å¤±è´¥ï¼Œè·³è¿‡äº†patchï¼Œæ‰‹å·¥å°†è·³è½¬nopæ‰ä¹‹åï¼Œèƒ½å¤Ÿæ­£å¸¸çš„æ‰§è¡Œpatchä»£ç ï¼Œæ‰€ä»¥åˆæ­¥å®šä½æ˜¯åç¨‹IDè·å–çš„åœ°æ–¹æœ‰é”™è¯¯ï¼Œå¯¼è‡´ç¨‹åºä¸­è·å–çš„åç¨‹IDå’Œæ±‡ç¼–ä»£ç ä¸­è·å–çš„åç¨‹IDä¸ä¸€è‡´ã€‚<br><img src="/2022/02/22/fix-concurrent-monkey-windows/x64debug.png" loading="lazy"></p>
<pre><code class="go">// é”™è¯¯çš„ä»£ç 
func getg() []byte &#123;
    return []byte&#123;
        // mov r12,QWORD PTR gs:0x28
        0x65, 0x4C, 0x8B, 0x24, 0x25, 0x28, 0x00, 0x00, 0x00,
    &#125;
&#125;
</code></pre>
<h2 id="æ¯”è¾ƒLinuxå’ŒWindowsä¸‹è·å–åç¨‹IDçš„å·®å¼‚"><a href="#æ¯”è¾ƒLinuxå’ŒWindowsä¸‹è·å–åç¨‹IDçš„å·®å¼‚" class="headerlink" title="æ¯”è¾ƒLinuxå’ŒWindowsä¸‹è·å–åç¨‹IDçš„å·®å¼‚"></a>æ¯”è¾ƒLinuxå’ŒWindowsä¸‹è·å–åç¨‹IDçš„å·®å¼‚</h2><p>æŒ‰ç…§åŸæ–‡ä½œè€…çš„æ–¹æ³•ï¼Œå†™äº†ä¸€æ®µä»£ç ç”¨äºåŸå§‹è·å–æ±‡ç¼–æŒ‡ä»¤</p>
<pre><code class="go">import &quot;github.com/huandu/go-tls/g&quot;

func main() &#123;
    _ = g.G()   // è¿™é‡Œå…¶å®æ²¡æœ‰å¿…è¦æŒ‰åŸæ–‡é‚£æ ·ä¿®æ”¹æºç ï¼Œç›´æ¥è¿™æ ·ä¹Ÿèƒ½æ‰¾åˆ°çš„
&#125;
</code></pre>
<p>åœ¨Linuxå’ŒWindowsä¸‹åˆ†åˆ«ç¼–è¯‘</p>
<pre><code class="shell">go build -ldflags=-w -gcflags &#39;-N -l&#39; main.go
</code></pre>
<p>dump</p>
<pre><code>// linux
go tool objdump main &gt; main.txt
// windows
go tool objdump main.exe &gt; main.txt
</code></pre>
<p>æ‰¾åˆ°getgçš„æ±‡ç¼–ä»£ç æ¯”è¾ƒ<br>Linux</p>
<pre><code class="asm">TEXT github.com/huandu/go-tls/g.getg.abi0(SB) /root/go/pkg/mod/github.com/huandu/go-tls@v1.0.1/g/getg_amd64.s
  getg_amd64.s:10    0x455420        64488b0425f8ffffff    MOVQ FS:0xfffffff8, AX    
  getg_amd64.s:11    0x455429        4889442408        MOVQ AX, 0x8(SP)    
  getg_amd64.s:12    0x45542e        c3            RET            
</code></pre>
<p>Windows</p>
<pre><code class="asm">TEXT github.com/huandu/go-tls/g.getg.abi0(SB) C:/Users/lzq/go/pkg/mod/github.com/huandu/go-tls@v1.0.1/g/getg_amd64.s
  getg_amd64.s:9    0x45ab80        65488b0c2528000000    MOVQ GS:0x28, CX    
  getg_amd64.s:10    0x45ab89        488b8100000000        MOVQ 0(CX), AX        
  getg_amd64.s:11    0x45ab90        4889442408        MOVQ AX, 0x8(SP)    
  getg_amd64.s:12    0x45ab95        c3            RET            
</code></pre>
<p>å¯ä»¥å‘ç°å…¶å®éåŸæ–‡æ‰€è¯´çš„å•çº¯åªæ˜¯åç§»å’Œå¯„å­˜å™¨ä¸ä¸€è‡´ï¼ŒWindowsä¸‹è¿˜å¤šäº†ä¸€è¡Œ</p>
<pre><code class="asm">  getg_amd64.s:10    0x45ab89        488b8100000000        MOVQ 0(CX), AX        
</code></pre>
<p>ä¹Ÿå°±æ˜¯è¯´åœ¨Windowsä¸‹å…¶å®æ˜¯2çº§æŒ‡é’ˆï¼Œä»<code>GS:0x28</code>è·å–å‡ºæ¥çš„æ˜¯ä¸€ä¸ªäºŒçº§æŒ‡é’ˆï¼Œè¿˜éœ€è¦ä¸€æ¬¡moveæ‰èƒ½è·å–åˆ°gçš„æŒ‡é’ˆ</p>
<h1 id="ä¿®å¤å’Œæµ‹è¯•"><a href="#ä¿®å¤å’Œæµ‹è¯•" class="headerlink" title="ä¿®å¤å’Œæµ‹è¯•"></a>ä¿®å¤å’Œæµ‹è¯•</h1><h2 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h2><p>çŸ¥é“é—®é¢˜äº†ï¼Œäºæ˜¯å°è¯•ä¿®æ”¹ä¸€æ³¢ï¼Œä¸è¿‡æˆ‘å¯¹æ±‡ç¼–ä¸æ˜¯å¾ˆç†Ÿï¼Œå¤§è‡´æƒ³æ³•æ˜¯å…ˆå°†äºŒçº§æŒ‡é’ˆç§»åˆ°r13ï¼Œåœ¨äºŒæ¬¡å–å€¼å›r12ï¼Œè¿™æ ·åªéœ€è¦ä¿®æ”¹getgçš„é€»è¾‘ï¼Œå…¶ä»–çš„ä»£ç å¯ä»¥ä¿æŒåŸæœ‰çš„é€»è¾‘ï¼Œå†™å…¥çš„åç¨‹IDåœ¨åé¢çš„ä»£ç ä¸­ä¼šè¦†ç›–æ‰r12ï¼Œç…§æˆ‘çš„ç†è§£åº”è¯¥æ˜¯æ²¡æœ‰é—®é¢˜ã€‚</p>
<pre><code class="go">func getg() []byte &#123;
    return []byte&#123;
        // mov r13,QWORD PTR gs:0x28
        0x65, 0x4C, 0x8B, 0x2C, 0x25, 0x28, 0x00, 0x00, 0x00,
        // mov r12,QWORD PTR [r13]
        0x4D, 0x8B, 0x65, 0x00,
    &#125;
&#125;
</code></pre>
<p><a target="_blank" rel="noopener" href="https://github.com/kkbblzq/monkey">ä¿®å¤åçš„ä»£ç </a> æˆ‘ä¹Ÿæäº†ä¸ªprç»™åŸä»“åº“</p>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><pre><code class="go">import (
    &quot;fmt&quot;
    //&quot;github.com/go-kiss/monkey&quot;
    &quot;github.com/kkbblzq/monkey&quot;
)

//go:noinline
func Add(a, b int) int &#123;
    return a + b
&#125;

func Add1(a, b int) int &#123;
    return 10
&#125;

func Add2(a, b int) int &#123;
    return 100
&#125;

func main() &#123;

    go func() &#123;
        monkey.Patch(Add, Add1)
        fmt.Printf(&quot;g1 add = %d\n&quot;, Add(99, 99))
    &#125;()

    go func() &#123;
        monkey.Patch(Add, Add2)
        fmt.Printf(&quot;g2 add = %d\n&quot;, Add(99, 99))
    &#125;()
    
    var input string
    fmt.Scanln(&amp;input)
&#125;
</code></pre>
<p>è¾“å‡º</p>
<pre><code>C:\Users\lzq\AppData\Local\Temp\GoLand\___go_build_monkeyDemo.exe
g1 add = 10
g2 add = 100
</code></pre>
<p>æµ‹è¯•ç¬¦åˆé¢„æœŸï¼Œæ”¶å·¥ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ç›®å‰monkey patchè¿™å—è¿˜æ˜¯æ¯”è¾ƒhackçš„è¡Œä¸ºï¼Œç”±äºå’Œåº•å±‚æ±‡ç¼–å®ç°å¼ºå…³è”ï¼Œéœ€è¦å•ç‹¬å»é€‚é…ä¸åŒçš„å¹³å°ã€ä¸åŒçš„æ¶æ„è¿˜æ˜¯æŒºè›‹ç–¼çš„ï¼Œä¸çŸ¥é“æ˜¯å¦æœ‰æ›´å¥½çš„æ–¹å¼æ¥å®ç°ï¼Œæ¯”å¦‚ä½¿ç”¨goçš„ä¸­é—´å±‚æ±‡ç¼–åœ¨æ‰§è¡Œçš„æ—¶å€™è½¬æ¢æˆå­—èŠ‚ç å†patchè¿›å»ï¼Œä¸è¿‡ç›®å‰å¥½åƒæ²¡æœ‰æ‰¾åˆ°å®ç°æ–¹å¼ï¼Œå¾…å®šå§~</p>

        
    </div>
    </div>

    <div class="article-badge">
        
        
    </div>

</div>

<footer class="article-footer">
    <div class="article-more-info">
    <div class="article-date">
  <time datetime="2022-02-22T13:53:49.000Z" itemprop="datePublished">2022-02-22</time>
</div>
    
    
    </div>
</footer>

</article>

    
  
    
      <article
id="post-program-optimization-essay"
class="article article-type-post"
>



<div class="article-inner">
    

    <div class="article-body">
    <header class="article-title">
        <a href="/2022/02/13/program-optimization-essay/">ç¨‹åºä¼˜åŒ–éšç¬”</a>
    </header>
    <div class="article-entry post-inner-html">
        
        <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><strong>è¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æº</strong><br>æ–‡æœ¬åªæ˜¯æä¾›ä¸€äº›ä¼˜åŒ–å¯èƒ½æ€§<br>æœ¬æ–‡ç›®å‰è¿˜åªæ˜¯ä¸ªè‰ç¨¿é›å½¢ï¼Œå¾…åç»­è¡¥å……</p>
<h2 id="å±€éƒ¨æ€§åŸç†"><a href="#å±€éƒ¨æ€§åŸç†" class="headerlink" title="å±€éƒ¨æ€§åŸç†"></a>å±€éƒ¨æ€§åŸç†</h2><p>ç°ä»£ç¨‹åºä¼˜åŒ–å¾ˆå¤§ä¸€éƒ¨åˆ†éƒ½åŸºäºå±€éƒ¨æ€§åŸç†æ¥è¿›è¡Œï¼Œè¿™ä¸»è¦æ˜¯ç”±äºå­˜å‚¨å™¨å’ŒCPUæœ¬èº«æ•ˆç‡çš„å·¨å¤§å·®è·ï¼Œè¿›è€Œå‡ºç°çš„å¤šçº§ç¼“å­˜æœºåˆ¶ï¼Œä¸å°‘ç¨‹åºä¼˜åŒ–å°±æ˜¯åˆ©ç”¨äº†è¿™ä¸€ç‚¹ï¼Œå°½å¯èƒ½ä¿è¯é«˜å±‚æ¬¡çš„å¿«é€Ÿç¼“å­˜èƒ½å¤Ÿå‘½ä¸­ï¼Œä»¥æ­¤æ¥æå‡ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚</p>
<h2 id="å…³äºç¼–è¯‘å™¨ä¼˜åŒ–"><a href="#å…³äºç¼–è¯‘å™¨ä¼˜åŒ–" class="headerlink" title="å…³äºç¼–è¯‘å™¨ä¼˜åŒ–"></a>å…³äºç¼–è¯‘å™¨ä¼˜åŒ–</h2><p>è™½ç„¶ç°ä»£ç¼–è¯‘å™¨ä¼˜åŒ–å·²ç»å¯ä»¥å¸®åŠ©å®Œæˆå¾ˆå¤šå¸¸è§„æƒ…å†µä¸‹çš„ä¼˜åŒ–ï¼Œä½†æ˜¯å› ä¸ºç¨‹åºæ‰§è¡Œä¸Šçš„ä¸ç¡®å®šæ€§ï¼Œæœ‰äº›ä»£ç ä¼šå¯¼è‡´å¦¨ç¢ç¼–è¯‘å™¨è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æ•°ç»„çš„è¶Šç•Œæ£€æŸ¥ã€å­˜å‚¨å™¨åˆ«åä½¿ç”¨ç­‰æƒ…å½¢ã€‚</p>
<ul>
<li>æ¡ˆä¾‹ è¾¹ç•Œæ£€æŸ¥<pre><code class="go">// æ£€æŸ¥1æ¬¡
func bounds1(s []int, index int) &#123;
  _ = s[index:]
  _ = s[:index]
&#125;
// æ£€æŸ¥2æ¬¡
func bounds2(s []int, index int) &#123;
  _ = s[:index]
  _ = s[index:]
&#125;
</code></pre>
</li>
<li>æ¡ˆä¾‹ å­˜å‚¨å™¨åˆ«åä½¿ç”¨</li>
</ul>
<pre><code class="go">func addDouble(a, b *int) &#123;
    *a += *b
    *a += *b
&#125;

func addDouble2(a, b *int) &#123;
    *a += 2 * *b
&#125;
</code></pre>
<p>è¿™2ä¸ªå‡½æ•°è¡¨é¢çœ‹èµ·æ¥æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ä½ è€ƒè™‘ä¸€ä¸‹aå’ŒbæŒ‡é’ˆç›¸ç­‰æƒ…å†µï¼Œå°±ä¼šå‘ç°å®é™…ä¸Šä»–ä»¬å¹¶ä¸ä¸€è‡´</p>
<h1 id="ä¼˜åŒ–ç‚¹"><a href="#ä¼˜åŒ–ç‚¹" class="headerlink" title="ä¼˜åŒ–ç‚¹"></a>ä¼˜åŒ–ç‚¹</h1><h2 id="ç¼“å­˜è¡Œ"><a href="#ç¼“å­˜è¡Œ" class="headerlink" title="ç¼“å­˜è¡Œ"></a>ç¼“å­˜è¡Œ</h2><h3 id="ç¼“å­˜æŠ–åŠ¨"><a href="#ç¼“å­˜æŠ–åŠ¨" class="headerlink" title="ç¼“å­˜æŠ–åŠ¨"></a>ç¼“å­˜æŠ–åŠ¨</h3><h2 id="åˆ©ç”¨æŒ‡ä»¤é›†"><a href="#åˆ©ç”¨æŒ‡ä»¤é›†" class="headerlink" title="åˆ©ç”¨æŒ‡ä»¤é›†"></a>åˆ©ç”¨æŒ‡ä»¤é›†</h2><p>å¦‚SSEæŒ‡ä»¤ï¼Œå¯ä»¥æé«˜å¯„å­˜å™¨åˆ©ç”¨ï¼Œé€šè¿‡å¹¶è¡Œçš„æ–¹å¼æé«˜æ•ˆç‡</p>

        
    </div>
    </div>

    <div class="article-badge">
        
        
    </div>

</div>

<footer class="article-footer">
    <div class="article-more-info">
    <div class="article-date">
  <time datetime="2022-02-13T07:08:23.000Z" itemprop="datePublished">2022-02-13</time>
</div>
    
    
    </div>
</footer>

</article>

    
  
    
      <article
id="post-hello-blog"
class="article article-type-post"
>



<div class="article-inner">
    

    <div class="article-body">
    <header class="article-title">
        <a href="/2022/02/12/hello-blog/">hello blog</a>
    </header>
    <div class="article-entry post-inner-html">
        
        <ul>
<li>æµ‹è¯•</li>
</ul>

        
    </div>
    </div>

    <div class="article-badge">
        
        
    </div>

</div>

<footer class="article-footer">
    <div class="article-more-info">
    <div class="article-date">
  <time datetime="2022-02-12T07:06:48.000Z" itemprop="datePublished">2022-02-12</time>
</div>
    
    
    </div>
</footer>

</article>

    
  

  
</div>

                </section>
            </section>

            
            <aside class="sidebar sidebar-search-fix">
                

    <div class="search">
    <div class="has-icon-right">
        <input type="text" class="form-input" id="search" placeholder="SEARCH" autocomplete="off">
        <div class="form-icon">
            <box-icon name='search' color="#3c4859"></box-icon>
        </div>
    </div>
    <div class="search-result" id="search-ps"></div>
</div>


<div class="widget" id="widget">
    
      
    
      

    
      

    
      
  <div class="widget-wrap widget-recent-posts">
    <div class="widget-title"><span>Recent Posts</span></div>
    <div class="widget-inner">
      <ul>
        
          <li>
            <a href="/2022/03/31/redis-code-active-expiry/">ä»æºç çœ‹Redis â€”â€” å…³äºä¸»åŠ¨è¿‡æœŸé‚£ç‚¹äº‹</a>
          </li>
        
          <li>
            <a href="/2022/03/03/manjaro-for-zephyrus-g14/">ROG Zephyrus G14 Manjaro-KDE åˆæ­¥å®‰è£…ä½“éªŒ</a>
          </li>
        
          <li>
            <a href="/2022/02/22/fix-concurrent-monkey-windows/">ä¿®æ­£monkeyè¡¥ä¸åœ¨windowsä¸‹å¤±è´¥çš„é—®é¢˜</a>
          </li>
        
          <li>
            <a href="/2022/02/13/program-optimization-essay/">ç¨‹åºä¼˜åŒ–éšç¬”</a>
          </li>
        
          <li>
            <a href="/2022/02/12/hello-blog/">hello blog</a>
          </li>
        
      </ul>
    </div>
  </div>

    
      
  <div class="widget-wrap widget-archive">
    <div class="widget-title"><span>Archive</span></div>
    <div class="widget-inner">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/">2022</a></li></ul>
    </div>
  </div>


    
</div>

<div id="backtop"><i class="icon icon-arrow-up"></i></div>
            </aside>
            
        </div>
    </div>

    <footer class="footer">
    <div class="footer-wave">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="#3c4859" fill-opacity="1" d="M0,160L60,181.3C120,203,240,245,360,240C480,235,600,181,720,186.7C840,192,960,256,1080,261.3C1200,267,1320,213,1380,186.7L1440,160L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z"></path></svg>
    </div>

    <!-- Please do not remove this -->
    <!-- å¼€æºä¸æ˜“ï¼Œè¯·å‹¿åˆ é™¤ -->
    <div class="footer-wrap">
        <div class="footer-inner"> 
            ç å¹´çºªäº‹ &copy; 2022<br>
            Powered By Hexo Â· Theme By <a href="https://linhong.me/" target="_blank">Aomori</a> Â· <a href="https://github.com/lh1me/hexo-theme-aomori" target="_blank">Github</a>
        </div>
    </div>

</footer>






<script src="/dist/build.js?1643276206136.js"></script>


<script src="/dist/custom.js?1643276206136.js"></script>










</body>

</html>